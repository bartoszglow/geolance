/*! geolance 2014-05-20 */
var app=angular.module("app",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{controller:"loginCtrl",templateUrl:"views/login.html"}).when("/map",{controller:"mapCtrl",templateUrl:"views/hospital/map.html"}).when("/list",{controller:"listCtrl",templateUrl:"views/hospital/list.html"}).when("/ambulance",{controller:"ambulanceCtrl",templateUrl:"views/ambulance/ambulance.html"}).otherwise({redirectTo:"/"})}]),app.factory("AuthenticationService",["$location","$http","$q",function(a,b,c){var d={};return{login:function(e){var f=c.defer();return"dispatcher"===e.username&&"password"===e.password?a.path("/map"):b.post("php/login.php",{username:e.username,password:e.password}).success(function(b){""!==b.username?(d=b,a.path("/ambulance"),f.resolve()):f.reject(b.error)}),f.promise},logout:function(){a.path("/")},getUsername:function(){return d.username}}}]),app.factory("ReceiveService",["$location","$http",function(a,b){var c=[];return receive=function(){b.post("php/receive.php").success(function(a){c=a;for(var b=0;b<c.length;b++)c[b].status=new Date(c[b].time)-new Date(c[b].lastLogin)>-714e4?"offline":"online",c[b].state="offline"==c[b].status?"-":0==c[b].state?"bussy":"free"})},setInterval(receive,5e3),{getData:function(a){for(var b=[],d=0;d<c.length;d++){b.push({});for(var e=0;e<a.length;e++)b[d][a[e]]=c[d][a[e]]}return b}}}]),app.controller("ambulanceCtrl",["$scope","$location","$http","AuthenticationService",function(a,b,c,d){a.status=!0,a.access=!1,a.update=function(){a.status===!0&&navigator.geolocation.getCurrentPosition(function(b){var e={username:d.getUsername(),access:a.access===!1?0:1,latitude:b.coords.latitude,longitude:b.coords.longitude,accuracy:b.coords.accuracy};c.post("php/update.php",e),a.timeout=setTimeout(a.update,5e3)})},a.statusChange=function(){a.status=$("#status:checked")[0]?!0:!1,$(".toogled").toggleClass("hidden"),window.clearTimeout(a.timeout),a.update()},a.accessChange=function(){a.access=$("#access:checked")[0]?!0:!1,window.clearTimeout(a.timeout),a.update()},a.logout=function(){d.logout()},window.scope=a,a.statusChange(),a.update()}]),app.controller("listCtrl",["$scope","ReceiveService",function(a,b){a.properties=["username","state","status","latitude","longitude","accuracy"],setInterval(function(){a.objects=b.getData(a.properties)},5e3),a.deleteAmbulance=function(){}}]),app.controller("loginCtrl",["$scope","AuthenticationService","$q",function(a,b){a.credentials={username:"",password:""},a.error="jestfdsfsd",$(".alert").hide(),window.scope=a,a.login=function(){a.promise=b.login(a.credentials),a.promise.then(function(){},function(b){a.error=b,a.showError()})},a.showError=function(){$(".alert").show(),setInterval(function(){$(".alert").hide()},3e3)}}]),app.controller("mapCtrl",["$scope","ReceiveService",function(a,b){function c(){setInterval(function(){j=i?i:b.getData(k),i=b.getData(k);for(var a=0;a<i.length;a++)d(a,new google.maps.LatLng(i[a].latitude,i[a].longitude));f()},5e3);var a={name:"Custom Style"},c="custom_style",h={zoom:13,center:o,mapTypeId:c,zoomControlOptions:{style:"SMALL"},mapTypeControlOptions:{position:"BOTTOM_CENTER"},streetViewControlOptions:{position:"BOTTOM_CENTER"}},l=new google.maps.StyledMapType(p,a);g=new google.maps.Map(document.getElementById("map-canvas"),h),g.mapTypes.set(c,l),m.setMap(g),google.maps.event.addListener(g,"click",function(a){e(a.latLng)});var n=document.getElementById("search-input"),q=new google.maps.places.SearchBox(n);google.maps.event.addListener(q,"places_changed",function(){var a=q.getPlaces();e(a[0].geometry.location)})}function d(a,b){i[a].marker="offline"==i[a].status?void 0:new google.maps.Marker({position:b,map:g,icon:"free"==i[a].state?"images/spotlight-poi-green.png":"images/spotlight-poi-blue.png"}),setTimeout(function(){j[a].marker&&(j[a].marker.setMap(null),j[a].marker=void 0)},50)}function e(a){h&&(h.setMap(null),h=null),h=new google.maps.Marker({position:a,map:g,icon:"images/spotlight-poi.png",draggable:!0,animation:google.maps.Animation.BOUNCE}),google.maps.event.addListener(h,"click",function(){h.setMap(null),h=null}),f()}function f(){for(var a={},b=0,c=0;c<i.length;c++)if(i[c].marker&&h){var d={origin:i[c].marker.position,destination:h.position,travelMode:google.maps.TravelMode.DRIVING};n.route(d,function(b,c){if(c==google.maps.DirectionsStatus.OK){for(var d=b.routes[0],e=0,f=0;f<d.legs.length;f++)e+=d.legs[f].distance.value;(e<a.distance||!a.distance)&&(a.distance=e,a.route=b,m.setDirections(a.route))}})}else b++,b==i.length&&m.set("directions",null)}var g,h,i,j,k=["username","state","status","latitude","longitude"],l={draggable:!0,suppressMarkers:!0,polylineOptions:{strokeColor:"#c0392b"}},m=new google.maps.DirectionsRenderer(l),n=new google.maps.DirectionsService,o=new google.maps.LatLng(52.411629,16.933938),p=[{featureType:"road",elementType:"all",stylers:[{color:"#1abc9c"},{saturation:60},{lightness:-20},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"landscape",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{color:"#ecf0f1"}]}];google.maps.event.addDomListener(window,"load",c),$(".list-button a").click(function(){var a=$(".list-container");a.hasClass("active")?a.removeClass("active").fadeOut(1e3):a.addClass("active").fadeIn(1e3)}),$("#search-input").click(function(){$("#search-input").parent().addClass("focus")}),$(".navbar").bind("click",function(a){a.target!=$("#search-input")[0]&&$("#search-input").parent().removeClass("focus")})}]);