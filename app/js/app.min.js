/*! geolance 2014-05-17 */
var app=angular.module("app",["ngRoute","google-maps"]);app.config(["$routeProvider",function(a){a.when("/",{controller:"loginCtrl",templateUrl:"views/login.html"}).when("/map",{controller:"mapCtrl",templateUrl:"views/hospital/map.html"}).when("/list",{controller:"listCtrl",templateUrl:"views/hospital/list.html"}).when("/ambulance",{controller:"ambulanceCtrl",templateUrl:"views/ambulance/ambulance.html"}).otherwise({redirectTo:"/"})}]),app.factory("AuthenticationService",["$location","$http","$q",function(a,b,c){var d={};return{login:function(e){var f=c.defer();return"dispatcher"===e.username&&"password"===e.password?(console.log(a),a.path("/map")):b.post("/geolance/php/login",{username:e.username,password:e.password}).success(function(b){""!==b.username?(d=b,a.path("/ambulance"),f.resolve()):f.reject(b.error)}),f.promise},logout:function(){a.path("/")},getUsername:function(){return d.username}}}]),app.factory("ReceiveService",["$location","$http",function(a,b){var c=[];return receive=function(){b.post("/geolance/php/receive").success(function(a){c=a;for(var b=0;b<c.length;b++)c[b].state=0==c[b].state?"bussy":"free",c[b].status=new Date-new Date(c[b].lastLogin)>1e4?"offline":"online"})},setInterval(receive,1e3),{getData:function(a){for(var b=[],d=0;d<c.length;d++){b.push({});for(var e=0;e<a.length;e++)b[d][a[e]]=c[d][a[e]]}return b}}}]),app.controller("ambulanceCtrl",["$scope","$location","$http","AuthenticationService",function(a,b,c,d){a.status=!0,a.access=!1,a.update=function(){a.status===!0&&navigator.geolocation.getCurrentPosition(function(b){var e={username:d.getUsername(),access:a.access===!1?0:1,latitude:b.coords.latitude,longitude:b.coords.longitude,accuracy:b.coords.accuracy};c.post("/geolance/php/update",e),console.log(1),a.timeout=setTimeout(a.update,3e3)})},a.statusChange=function(){a.status=$("#status:checked")[0]?!0:!1,$(".toogled").toggleClass("hidden"),window.clearTimeout(a.timeout),a.update()},a.accessChange=function(){a.access=$("#access:checked")[0]?!0:!1,window.clearTimeout(a.timeout),a.update()},a.logout=function(){d.logout()},window.scope=a,a.statusChange(),a.update()}]),app.controller("listCtrl",["$scope","ReceiveService",function(a,b){a.objects=[{},{}],a.properties=["username","state","status"],setInterval(function(){a.objects=b.getData(a.properties)},1e3),a.deleteAmbulance=function(){}}]),app.controller("loginCtrl",["$scope","AuthenticationService","$q",function(a,b){a.credentials={username:"",password:""},a.error="jestfdsfsd",$(".alert").hide(),window.scope=a,a.login=function(){a.promise=b.login(a.credentials),a.promise.then(function(){},function(b){a.error=b,a.showError()})},a.showError=function(){$(".alert").show(),setInterval(function(){$(".alert").hide()},3e3)}}]),app.controller("mapCtrl",["$scope","ReceiveService",function(a,b){function c(b,c){if(a.objects[b].marker){if(a.objects[b].marker.position.A==c.A&&a.objects[b].marker.position.k==c.k)return!1;a.objects[b].marker.setMap(null),a.objects[b].marker=null}a.objects[b].marker=new google.maps.Marker({position:c,map:h})}function d(b){a.marker&&(a.marker.setMap(null),a.marker=null),a.marker=new google.maps.Marker({position:b,map:h,draggable:!0,animation:google.maps.Animation.DROP})}function e(){var a={zoom:13,center:l};h=new google.maps.Map(document.getElementById("map-canvas"),a),j.setMap(h),google.maps.event.addListener(j,"directions_changed",function(){g(j.getDirections())}),setInterval(function(){google.maps.event.addListener(h,"click",function(a){d(a.latLng),f()})},4e3)}function f(){var b={origin:a.marker.position,destination:a.objects[1].marker.position,travelMode:google.maps.TravelMode.DRIVING};k.route(b,function(a,b){b==google.maps.DirectionsStatus.OK&&j.setDirections(a)})}function g(a){for(var b=0,c=a.routes[0],d=0;d<c.legs.length;d++)b+=c.legs[d].distance.value;b/=1e3,document.getElementById("total").innerHTML=b+" km"}a.objects=[{},{}],a.properties=["username","state","status","latitude","longitude"],setInterval(function(){a.objects=b.getData(a.properties);for(var d=0;d<a.objects.length;d++)c(d,new google.maps.LatLng(a.objects[d].latitude,a.objects[d].longitude))},5e3);var h,i={draggable:!0},j=new google.maps.DirectionsRenderer(i),k=new google.maps.DirectionsService,l=new google.maps.LatLng(52.411629,16.933938);google.maps.event.addDomListener(window,"load",e)}]);